<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロフィール - 座の人</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* profile.html 固有のスタイル */
        .main-content-profile { /* style.cssの共通クラスに合わせる */
            padding: 20px;
            background-color: #fff;
        }
        .profile-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .profile-header h2 { margin: 0; font-size: 1.8em; }
        .edit-button { background-color: #808080; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; }
        .edit-button:hover { background-color: #666666; }
        .profile-info { margin-bottom: 30px; padding: 20px; border: 1px solid #eee; border-radius: 8px; display: flex; align-items: flex-start; background-color: #fcfcfc; }
        .profile-image-container { margin-right: 25px; flex-shrink: 0; }
        .profile-image { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; }
        .profile-details { flex-grow: 1; }
        .profile-details p { margin-bottom: 10px; line-height: 1.6; }
        .profile-details strong { font-weight: bold; color: #555; margin-right: 5px; }
        .profile-edit-form { display: none; margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #f8f9fa; }
        .profile-edit-form h3 { margin-top:0; margin-bottom:20px; font-size:1.5em; border-bottom:1px solid #ccc; padding-bottom:10px;}
        .profile-edit-form label { display: block; margin-bottom: 6px; font-weight: bold; color: #444; }
        .profile-edit-form input[type="text"],
        .profile-edit-form select,
        .profile-edit-form textarea,
        .profile-edit-form input[type="file"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
        .profile-edit-form textarea { min-height: 80px; resize: vertical; }
        #image-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 1px solid #ccc; margin-top: 10px; display: block; }
        .profile-edit-form button[type="submit"] { background-color: #5cb85c; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; width: auto; display: inline-block; }
        .profile-edit-form button[type="submit"]:hover { background-color: #4cae4c; }
        .profile-edit-form .cancel-button { background-color: #808080; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; width: auto; display: inline-block; margin-left:10px; }
        .profile-edit-form .cancel-button:hover { background-color: #666; }
        .recent-essays-section { margin-top: 40px; }
        .recent-essays-section h3 { font-size: 1.6em; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
        #recent-profile-essays-list { list-style: none; padding: 0; margin: 0; }
        /* .essay-item-logged-in スタイルは style.css のものを流用 */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>座の人</h1>
            <nav>
                <ul>
                    <li><a href="logged_in.html">ホーム</a></li>
                    <li><a href="bulletinboard.html">掲示板</a></li>
                </ul>
            </nav>
        </header>
        <main>
            <div id="left-column-container">
                <!-- _left_column_logged_in.html が読み込まれる -->
            </div>
            <div class="main-content-profile"> <!-- ★クラス名を style.css の共通クラスに合わせる -->
                <div class="profile-header">
                    <h2>プロフィール</h2>
                    <button id="edit-profile-button" class="edit-button">編集</button>
                </div>
                <div class="profile-info" id="profile-display">
                    <div class="profile-image-container">
                        <img src="default_user.png" alt="プロフィール画像" class="profile-image" id="display-profile-image">
                    </div>
                    <div class="profile-details">
                        <p><strong>ユーザー名:</strong> <span id="display-username">[ユーザー名]</span></p>
                        <p><strong>年齢:</strong> <span id="display-age">[年齢]</span></p>
                        <p><strong>性別:</strong> <span id="display-gender">[性別]</span></p>
                        <p><strong>血液型:</strong> <span id="display-blood_type">[血液型]</span></p>
                        <p><strong>星座:</strong> <span id="display-star_sign">[星座]</span></p>
                        <p><strong>居住地:</strong> <span id="display-residence">[居住地]</span></p>
                        <p><strong>身長:</strong> <span id="display-height">[身長]</span></p>
                        <p><strong>好きな芸能人:</strong> <span id="display-favorite_celebrity">[好きな芸能人]</span></p>
                        <p><strong>好きなタイプ:</strong> <span id="display-favorite_type">[好きなタイプ]</span></p>
                        <p><strong>好きな食べ物:</strong> <span id="display-favorite_food">[好きな食べ物]</span></p>
                        <p><strong>表向きの趣味:</strong> <span id="display-public_hobby">[表向きの趣味]</span></p>
                        <p><strong>ここでしか言えない趣味:</strong> <span id="display-private_hobby">[ここでしか言えない趣味]</span></p>
                        <p><strong>特技:</strong> <span id="display-skill">[特技]</span></p>
                        <p><strong>好きなマンガ:</strong> <span id="display-favorite_manga">[好きなマンガ]</span></p>
                        <p><strong>好きな映画・アニメ・ラジオ:</strong> <span id="display-favorite_media">[好きな映画・アニメ・ラジオ]</span></p>
                        <p><strong>座右の銘:</strong> <span id="display-motto">[座右の銘]</span></p>
                        <p><strong>必殺技:</strong> <span id="display-ultimate_skill">[必殺技]</span></p>
                        <p><strong>許せない人のタイプ:</strong> <span id="display-disliked_person">[許せない人のタイプ]</span></p>
                        <p><strong>将来の夢:</strong> <span id="display-future_dream">[将来の夢]</span></p>
                    </div>
                </div>
                <form id="profile-edit-form" class="profile-edit-form">
                    <h3>プロフィール編集</h3>
                    <div><label for="edit_profile_image">プロフィール画像:</label><input type="file" id="edit_profile_image" name="profile_image" accept="image/*"><img src="default_user.png" alt="プレビュー" id="image-preview"></div>
                    <div><label for="edit_username">ユーザー名:</label><input type="text" id="edit_username" name="username" required></div>
                    <div><label for="edit_age">年齢:</label><input type="text" id="edit_age" name="age"></div>
                    <div><label for="edit_gender">性別:</label><select id="edit_gender" name="gender"><option value="">選択してください</option><option value="male">男性</option><option value="female">女性</option><option value="other">その他</option></select></div>
                    <div><label for="edit_blood_type">血液型:</label><select id="edit_blood_type" name="blood_type"><option value="">選択してください</option><option value="A">A型</option><option value="B">B型</option><option value="O">O型</option><option value="AB">AB型</option></select></div>
                    <div><label for="edit_star_sign">星座:</label><input type="text" id="edit_star_sign" name="star_sign"></div>
                    <div><label for="edit_residence">居住地:</label><input type="text" id="edit_residence" name="residence"></div>
                    <div><label for="edit_height">身長:</label><input type="text" id="edit_height" name="height"></div>
                    <div><label for="edit_favorite_celebrity">好きな芸能人:</label><textarea id="edit_favorite_celebrity" name="favorite_celebrity"></textarea></div>
                    <div><label for="edit_favorite_type">好きなタイプ:</label><textarea id="edit_favorite_type" name="favorite_type"></textarea></div>
                    <div><label for="edit_favorite_food">好きな食べ物:</label><textarea id="edit_favorite_food" name="favorite_food"></textarea></div>
                    <div><label for="edit_public_hobby">表向きの趣味:</label><textarea id="edit_public_hobby" name="public_hobby"></textarea></div>
                    <div><label for="edit_private_hobby">ここでしか言えない趣味:</label><textarea id="edit_private_hobby" name="private_hobby"></textarea></div>
                    <div><label for="edit_skill">特技:</label><textarea id="edit_skill" name="skill"></textarea></div>
                    <div><label for="edit_favorite_manga">好きなマンガ:</label><textarea id="edit_favorite_manga" name="favorite_manga"></textarea></div>
                    <div><label for="edit_favorite_media">好きな映画・アニメ・ラジオ:</label><textarea id="edit_favorite_media" name="favorite_media"></textarea></div>
                    <div><label for="edit_motto">座右の銘:</label><textarea id="edit_motto" name="motto"></textarea></div>
                    <div><label for="edit_ultimate_skill">必殺技:</label><textarea id="edit_ultimate_skill" name="ultimate_skill"></textarea></div>
                    <div><label for="edit_disliked_person">許せない人のタイプ:</label><textarea id="edit_disliked_person" name="disliked_person"></textarea></div>
                    <div><label for="edit_future_dream">将来の夢:</label><textarea id="edit_future_dream" name="future_dream"></textarea></div>
                    <button type="submit">保存</button>
                    <button type="button" id="cancel-edit-button" class="cancel-button">キャンセル</button>
                </form>
                <section class="recent-essays-section">
                    <h3>最近の随筆</h3>
                    <ul id="recent-profile-essays-list">
                        <!-- script.jsによってここに最近の随筆が挿入されます -->
                    </ul>
                </section>
                <p style="margin-top: 30px; text-align:center;"><a href="logged_in.html">ホームに戻る</a></p>
            </div>
        </main>
        <footer>
            <p>© 2025 座の人</p>
        </footer>
    </div>
    <script src="load_parts.js"></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded for profile.html inline script.");
            if (typeof loadHTMLPart === 'function') {
                console.log("Calling loadHTMLPart for _left_column_logged_in.html on profile.html...");
                loadHTMLPart('_left_column_logged_in.html', 'left-column-container', null, () => {
                    console.log("CALLBACK: Left column loaded into profile.html by loadHTMLPart.");
                    if (typeof initializeLeftColumnContent === "function") {
                        console.log("CALLBACK: Calling initializeLeftColumnContent for profile.html...");
                        initializeLeftColumnContent();
                    } else {
                        console.error("CALLBACK: initializeLeftColumnContent is not defined on profile.html!");
                    }
                    // プロフィールページ専用のメインコンテンツ初期化関数を呼び出す
                    if (typeof initializeProfilePage === "function") {
                        console.log("CALLBACK: Calling initializeProfilePage for profile.html...");
                        initializeProfilePage();
                    } else {
                        console.error("CALLBACK: initializeProfilePage is not defined on profile.html!");
                    }
                });
            } else {
                console.error("loadHTMLPart function is not defined on profile.html.");
            }

            // 既存のプロフィール編集関連のインラインJavaScriptは、
            // initializeProfilePage 関数内で処理するように script.js に移すことを推奨します。
            // ここに残す場合は、script.js側のグローバル関数と連携させる必要があります。
            // 今回は、script.js の initializeProfilePage で最近の随筆リストを描画し、
            // プロフィール編集ロジックは、このインラインスクリプトで引き続き動作させることを想定します。
            // (ただし、localStorageのキー名は script.js の currentLoggedInUser と合わせる必要があります)

            const editProfileButton = document.getElementById('edit-profile-button');
            const profileDisplay = document.getElementById('profile-display');
            const profileEditForm = document.getElementById('profile-edit-form');
            const cancelEditButton = document.getElementById('cancel-edit-button');
            const form = document.getElementById('profile-edit-form');
            const imagePreview = document.getElementById('image-preview');
            const editProfileImageInput = document.getElementById('edit_profile_image');
            const displayProfileImage = document.getElementById('display-profile-image');

            const profileFields = {
                username: { display: 'display-username', edit: 'edit_username' },
                age: { display: 'display-age', edit: 'edit_age' },
                gender: { display: 'display-gender', edit: 'edit_gender' },
                blood_type: { display: 'display-blood_type', edit: 'edit_blood_type' },
                star_sign: { display: 'display-star_sign', edit: 'edit_star_sign' },
                residence: { display: 'display-residence', edit: 'edit_residence' },
                height: { display: 'display-height', edit: 'edit_height' },
                favorite_celebrity: { display: 'display-favorite_celebrity', edit: 'edit_favorite_celebrity' },
                favorite_type: { display: 'display-favorite_type', edit: 'edit_favorite_type' },
                favorite_food: { display: 'display-favorite_food', edit: 'edit_favorite_food' },
                public_hobby: { display: 'display-public_hobby', edit: 'edit_public_hobby' },
                private_hobby: { display: 'display-private_hobby', edit: 'edit_private_hobby' },
                skill: { display: 'display-skill', edit: 'edit_skill' },
                favorite_manga: { display: 'display-favorite_manga', edit: 'edit_favorite_manga' },
                favorite_media: { display: 'display-favorite_media', edit: 'edit_favorite_media' },
                motto: { display: 'display-motto', edit: 'edit_motto' },
                ultimate_skill: { display: 'display-ultimate_skill', edit: 'edit_ultimate_skill' },
                disliked_person: { display: 'display-disliked_person', edit: 'edit_disliked_person' },
                future_dream: { display: 'display-future_dream', edit: 'edit_future_dream' }
            };
            const genderMap = { "": "-", "male": "男性", "female": "女性", "other": "その他" };

            function loadProfileDataFromStorage() { // 関数名を変更
                const storedProfile = localStorage.getItem('userProfile'); // script.js と同じキー名
                return storedProfile ? JSON.parse(storedProfile) : {};
            }
            let userProfileData = loadProfileDataFromStorage(); // 変数名を変更

            function updateProfileDisplayElements() { // 関数名を変更
                for (const key in profileFields) {
                    const displayEl = document.getElementById(profileFields[key].display);
                    if (displayEl) {
                        if (key === 'gender') {
                            displayEl.textContent = genderMap[userProfileData[key]] || '-';
                        } else {
                            displayEl.textContent = userProfileData[key] || '-';
                        }
                    }
                }
                displayProfileImage.src = userProfileData.profileImage || 'default_user.png';
                // 左カラムのユーザー情報も更新 (script.jsのcurrentLoggedInUserと同期)
                if (window.currentLoggedInUser) {
                    window.currentLoggedInUser.name = userProfileData.username || "座の人ユーザー";
                    window.currentLoggedInUser.profileImageUrl = userProfileData.profileImage || null;
                    if (typeof initializeLeftColumnContent === "function") {
                        initializeLeftColumnContent(); // 左カラムを再描画
                    }
                }
            }

            function populateEditFormElements() { // 関数名を変更
                for (const key in profileFields) {
                    const editEl = document.getElementById(profileFields[key].edit);
                    if (editEl) {
                        editEl.value = userProfileData[key] || '';
                    }
                }
                imagePreview.src = userProfileData.profileImage || 'default_user.png';
            }

            updateProfileDisplayElements();
            populateEditFormElements();

            if(editProfileButton) {
                editProfileButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    userProfileData = loadProfileDataFromStorage(); // 編集開始時に最新データを再読み込み
                    populateEditFormElements();
                    profileDisplay.style.display = 'none';
                    profileEditForm.style.display = 'block';
                });
            }

            if(cancelEditButton) {
                cancelEditButton.addEventListener('click', () => {
                    profileEditForm.style.display = 'none';
                    profileDisplay.style.display = 'block';
                    populateEditFormElements(); // フォームの内容を元に戻す
                    imagePreview.src = userProfileData.profileImage || 'default_user.png';
                    editProfileImageInput.value = '';
                });
            }

            if(editProfileImageInput) {
                editProfileImageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => { imagePreview.src = event.target.result; }
                        reader.readAsDataURL(file);
                    } else {
                        imagePreview.src = userProfileData.profileImage || 'default_user.png';
                    }
                });
            }

            if(form) {
                form.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const newProfileData = {};
                    for (const key in profileFields) {
                        const editEl = document.getElementById(profileFields[key].edit);
                        if (editEl) {
                            newProfileData[key] = editEl.value;
                        }
                    }

                    const profileImageFile = editProfileImageInput.files[0];
                    if (profileImageFile) {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            newProfileData.profileImage = reader.result;
                            userProfileData = { ...userProfileData, ...newProfileData }; // 更新
                            localStorage.setItem('userProfile', JSON.stringify(userProfileData));
                            updateProfileDisplayElements();
                            profileDisplay.style.display = 'block';
                            profileEditForm.style.display = 'none';
                            alert('プロフィールを保存しました！');
                        }
                        reader.readAsDataURL(profileImageFile);
                    } else {
                        newProfileData.profileImage = userProfileData.profileImage; // 既存の画像を維持
                        userProfileData = { ...userProfileData, ...newProfileData }; // 更新
                        localStorage.setItem('userProfile', JSON.stringify(userProfileData));
                        updateProfileDisplayElements();
                        profileDisplay.style.display = 'block';
                        profileEditForm.style.display = 'none';
                        alert('プロフィールを保存しました！');
                    }
                });
            }
        });
    </script>
</body>
</html>