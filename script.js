// script.js (Refactored & Fixed for Empty Comment Message - Full Code)

// --- 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
function escapeHtml(unsafe) { if (typeof unsafe !== 'string') { return unsafe; } return unsafe.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, '"').replace(/'/g, "'"); }
function getCrownHtml(rank) { if (rank === 1) { return '<span class="crown gold">ğŸ‘‘</span>'; } return ''; }
function getQueryParam(param) { const urlParams = new URLSearchParams(window.location.search); return urlParams.get(param); }

// --- 2. ã‚µã‚¤ãƒˆå…¨ä½“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ---
const App = {
    // --- 2.1. ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ ---
    currentUser: {}, essays: [], popularEssays: [], mediaItems: [], allThreads: [], notifications: [], allComments: {}, threadComments: {},
    followingUsers: [ { name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼A", profileUrl: "profile.html?user=userA" }, { name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼B", profileUrl: "profile.html?user=userB" }, { name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼C", profileUrl: "profile.html?user=userC" }, ],
    categoryDisplayNames: { zatsudan: 'é›‘è«‡', news: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹', work: 'ä¼šç¤¾ãƒ»ä»•äº‹', anime: 'ã‚¢ãƒ‹ãƒ¡', sports: 'ã‚¹ãƒãƒ¼ãƒ„', tv: 'ãƒ†ãƒ¬ãƒ“', game: 'ã‚²ãƒ¼ãƒ ', unknown: 'ãã®ä»–' },
    profileFields: { username: { display: 'display-username', edit: 'edit_username' }, age: { display: 'display-age', edit: 'edit_age' }, gender: { display: 'display-gender', edit: 'edit_gender' }, blood_type: { display: 'display-blood_type', edit: 'edit_blood_type' }, star_sign: { display: 'display-star_sign', edit: 'edit_star_sign' }, residence: { display: 'display-residence', edit: 'edit_residence' }, height: { display: 'display-height', edit: 'edit_height' }, favorite_celebrity: { display: 'display-favorite_celebrity', edit: 'edit_favorite_celebrity' }, favorite_type: { display: 'display-favorite_type', edit: 'edit_favorite_type' }, favorite_food: { display: 'display-favorite_food', edit: 'edit_favorite_food' }, public_hobby: { display: 'display-public_hobby', edit: 'edit_public_hobby' }, private_hobby: { display: 'display-private_hobby', edit: 'edit_private_hobby' }, skill: { display: 'display-skill', edit: 'edit_skill' }, favorite_manga: { display: 'display-favorite_manga', edit: 'edit_favorite_manga' }, favorite_media: { display: 'display-favorite_media', edit: 'edit_favorite_media' }, motto: { display: 'display-motto', edit: 'edit_motto' }, ultimate_skill: { display: 'display-ultimate_skill', edit: 'edit_ultimate_skill' }, disliked_person: { display: 'display-disliked_person', edit: 'edit_disliked_person' }, future_dream: { display: 'display-future_dream', edit: 'edit_future_dream' } },
    genderMap: { "": "[æœªè¨­å®š]", "male": "ç”·æ€§", "female": "å¥³æ€§", "other": "ãã®ä»–" },
    bloodTypeMap: { "": "[æœªè¨­å®š]", "A": "Aå‹", "B": "Bå‹", "O": "Oå‹", "AB": "ABå‹" },

    // --- 2.2. ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ãƒ¡ã‚½ãƒƒãƒ‰ ---
    initializeData: function() { const profile = JSON.parse(localStorage.getItem('userProfile') || '{}'); this.currentUser = { name: profile.username || "åº§ã®äººãƒ¦ãƒ¼ã‚¶ãƒ¼", profileImageUrl: profile.profileImage || "default_user_thumb.png" }; const storedEssays = localStorage.getItem('essays'); this.essays = storedEssays ? JSON.parse(storedEssays) : this.getSampleEssays(); if (!storedEssays) localStorage.setItem('essays', JSON.stringify(this.essays)); const storedThreads = localStorage.getItem('allThreads'); this.allThreads = storedThreads ? JSON.parse(storedThreads) : this.getSampleThreads(); if (!storedThreads) localStorage.setItem('allThreads', JSON.stringify(this.allThreads)); const storedEssayComments = localStorage.getItem('allComments'); this.allComments = storedEssayComments ? JSON.parse(storedEssayComments) : this.getSampleEssayComments(); if (!storedEssayComments) localStorage.setItem('allComments', JSON.stringify(this.allComments)); this.threadComments = JSON.parse(localStorage.getItem('threadComments') || '{}'); this.popularEssays = this.getSamplePopularEssays(); this.notifications = this.getSampleNotifications(); this.initializeMediaItems(); },
    // --- 2.3. ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆãƒ¡ã‚½ãƒƒãƒ‰ç¾¤ ---
    getSampleEssays: function() { return [ { id: 1, title: 'ã‚µã‚¤ãƒˆé–‹è¨­ã®ã”æŒ¨æ‹¶', author: 'ç®¡ç†äºº', snippet: 'ã“ã®ã‚µã‚¤ãƒˆã€Œåº§ã®äººã€ã‚’é–‹è¨­ã—ã¾ã—ãŸã€‚æ—¥ã€…ã®é›‘è¨˜ã‚„æ€ã£ãŸã“ã¨ã‚’æ°—ã¾ã¾ã«ç¶´ã£ã¦ã„ãã¾ã™ã€‚', date: '2024-05-21', image: 'https://dummyimage.com/600x400/777/fff&text=Greeting+Image', videoUrl: null, body: 'ã“ã®ã‚µã‚¤ãƒˆã€Œåº§ã®äººã€ã‚’é–‹è¨­ã—ã¾ã—ãŸã€‚<br>æ—¥ã€…ã®é›‘è¨˜ã‚„æ€ã£ãŸã“ã¨ã‚’æ°—ã¾ã¾ã«ç¶´ã£ã¦ã„ãã¾ã™ã€‚<br><br>ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚' }, { id: 2, title: 'ãŠæ°—ã«å…¥ã‚Šã®ã‚«ãƒ•ã‚§ç´¹ä»‹ (å‹•ç”»ã‚ã‚Š)', author: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼A', snippet: 'æœ€è¿‘è¦‹ã¤ã‘ãŸã‚«ãƒ•ã‚§ãŒã¨ã¦ã‚‚ç´ æ•µã§ã™ã€‚å‹•ç”»ã§é›°å›²æ°—ã‚’ã”è¦§ãã ã•ã„ã€‚', date: '2024-05-20', image: null, videoUrl: 'sample_video.mp4', body: 'æœ€è¿‘è¦‹ã¤ã‘ãŸã‚«ãƒ•ã‚§ãŒã¨ã¦ã‚‚ç´ æ•µã§ã™ã€‚<br>é™ã‹ã§è½ã¡ç€ã„ãŸé›°å›²æ°—ã§ã€ã‚³ãƒ¼ãƒ’ãƒ¼ã‚‚ç¾å‘³ã—ã„ã€‚<br>ä½œæ¥­ã«ã‚‚èª­æ›¸ã«ã‚‚ã´ã£ãŸã‚Šãªç©ºé–“ã§ã™ã€‚ãŠåº—ã®åå‰ã¯ã€Œã‚«ãƒ•ã‚§ãƒ»ãƒ‰ãƒ»ãƒªãƒ©ãƒƒã‚¯ã‚¹ã€ã€‚<br>ãœã²ä¸€åº¦è¨ªã‚Œã¦ã¿ã¦ãã ã•ã„ã€‚ (sample_video.mp4ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ€ãƒŸãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ã„ã¦ãã ã•ã„)' }, { id: 3, title: 'é€±æœ«ã®ãƒã‚¤ã‚­ãƒ³ã‚°è¨˜éŒ²', author: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼B', snippet: 'å¤©æ°—ãŒè‰¯ã‹ã£ãŸã®ã§ã€è¿‘ãã®å±±ã¸ãƒã‚¤ã‚­ãƒ³ã‚°ã«è¡Œã£ã¦ãã¾ã—ãŸã€‚é ‚ä¸Šã‹ã‚‰ã®æ™¯è‰²ã¯æœ€é«˜ã§ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã§ãã¾ã—ãŸï¼', date: '2024-05-19', image: 'https://dummyimage.com/600x400/4CAF50/fff&text=Hiking+Detail', videoUrl: null, body: 'å¤©æ°—ãŒè‰¯ã‹ã£ãŸã®ã§ã€è¿‘ãã®ã€Œè¦‹æ™´ã‚‰ã—å±±ã€ã¸ãƒã‚¤ã‚­ãƒ³ã‚°ã«è¡Œã£ã¦ãã¾ã—ãŸã€‚<br>ç‰‡é“ç´„1æ™‚é–“åŠã®é“ã®ã‚Šã§ã—ãŸãŒã€æ–°ç·‘ãŒã¨ã¦ã‚‚ç¶ºéº—ã§æ°—æŒã¡ã‚ˆã‹ã£ãŸã§ã™ã€‚<br>é ‚ä¸Šã‹ã‚‰ã®æ™¯è‰²ã¯æœ€é«˜ã§ã€æ—¥é ƒã®ç–²ã‚Œã‚‚å¹ãé£›ã³ã¾ã—ãŸï¼<br>ãŠå¼å½“ã‚‚ç¾å‘³ã—ã‹ã£ãŸã€‚ã¾ãŸè¡ŒããŸã„ã§ã™ã€‚' }, { id: 4, title: 'èª­ã‚“ã æœ¬ã®æ„Ÿæƒ³ï¼šæ€è€ƒã®æ•´ç†å­¦', author: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼C', snippet: 'å¤–å±±æ»‹æ¯”å¤æ°ã®ã€Œæ€è€ƒã®æ•´ç†å­¦ã€ã‚’èª­ã¿ã¾ã—ãŸã€‚ã‚°ãƒ©ã‚¤ãƒ€ãƒ¼èƒ½åŠ›ã¨é£›è¡Œæ©Ÿèƒ½åŠ›ã®è©±ãŒå°è±¡çš„ã€‚è‡ªåˆ†ã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’è¦‹ç›´ã™è‰¯ã„ãã£ã‹ã‘ã«ãªã‚Šã¾ã—ãŸã€‚', date: '2024-05-18', image: null, videoUrl: null, body: 'å¤–å±±æ»‹æ¯”å¤æ°ã®ã€Œæ€è€ƒã®æ•´ç†å­¦ã€ã‚’èª­ã¿ã¾ã—ãŸã€‚<br>ç‰¹ã«ã€Œã‚°ãƒ©ã‚¤ãƒ€ãƒ¼èƒ½åŠ›ã€ã¨ã€Œé£›è¡Œæ©Ÿèƒ½åŠ›ã€ã®è©±ãŒå°è±¡çš„ã§ã—ãŸã€‚<br>æƒ…å ±ã‚’é›†ã‚ã‚‹ã ã‘ã§ãªãã€ãã‚Œã‚’è‡ªåˆ†ãªã‚Šã«ç™ºé…µã•ã›ã€æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç”Ÿã¿å‡ºã™ã“ã¨ã®é‡è¦æ€§ã‚’å†èªè­˜ã—ã¾ã—ãŸã€‚<br>è‡ªåˆ†ã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’è¦‹ç›´ã™è‰¯ã„ãã£ã‹ã‘ã«ãªã£ãŸä¸€å†Šã§ã™ã€‚' }, { id: 5, title: 'æ–°ã—ã„è¶£å‘³ã€å§‹ã‚ã¾ã—ãŸï¼', author: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼', snippet: 'æœ€è¿‘ã€æ–™ç†ã‚’å§‹ã‚ã¾ã—ãŸã€‚ä½œã‚‹ã®ã‚‚é£Ÿã¹ã‚‹ã®ã‚‚æ¥½ã—ã„ã§ã™ã€‚ç¾å‘³ã—ã„ãƒ‘ã‚¹ã‚¿ãŒä½œã‚Œã‚‹ã‚ˆã†ã«ãªã‚ŠãŸã„ãªã€‚', date: '2024-05-22', image: 'https://dummyimage.com/600x400/333/fff&text=Cooking+Detail', videoUrl: null, body: 'æœ€è¿‘ã€æ–°ã—ã„è¶£å‘³ã¨ã—ã¦æ–™ç†ã‚’å§‹ã‚ã¾ã—ãŸï¼<br>ã“ã‚Œã¾ã§ã‚ã¾ã‚Šè‡ªç‚Šã‚’ã—ã¦ã“ãªã‹ã£ãŸã®ã§ã™ãŒã€æŒ‘æˆ¦ã—ã¦ã¿ã‚‹ã¨æ„å¤–ã¨æ¥½ã—ãã¦ãƒãƒã£ã¦ã„ã¾ã™ã€‚<br>ä½œã‚‹ã®ã‚‚é£Ÿã¹ã‚‹ã®ã‚‚æ¥½ã—ã„ã§ã™ã­ã€‚<br>ç›®ä¸‹ã®ç›®æ¨™ã¯ã€ç¾å‘³ã—ã„ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒãŒä½œã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ã§ã™ï¼' }, { id: 6, title: 'åº§ã®äººãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¥è¨˜ï¼‘ (å‹•ç”»ä»˜ã)', author: 'åº§ã®äººãƒ¦ãƒ¼ã‚¶ãƒ¼', snippet: 'ã“ã‚Œã¯åº§ã®äººãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹æœ€åˆã®æŠ•ç¨¿ã§ã™ã€‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚', date: '2024-06-01', image: null, videoUrl: 'sample_video2.mp4', body: 'åº§ã®äººãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ã€‚<br>ã“ã®ãƒŸãƒ‹ãƒ–ãƒ­ã‚°ã§ã€æ—¥ã€…ã®å‡ºæ¥äº‹ã‚„è€ƒãˆã‚’å…±æœ‰ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚<br>è¶£å‘³ã¯èª­æ›¸ã¨æ•£æ­©ã§ã™ã€‚ä»Šæ—¥ã¯æ•£æ­©ä¸­ã«è¦‹ã¤ã‘ãŸé¢¨æ™¯ã‚’å‹•ç”»ã§ã©ã†ãã€‚(sample_video2.mp4ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ€ãƒŸãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ã„ã¦ãã ã•ã„)' }, { id: 7, title: 'æœ€è¿‘è¦³ãŸæ˜ ç”»ã«ã¤ã„ã¦', author: 'åº§ã®äººãƒ¦ãƒ¼ã‚¶ãƒ¼', snippet: 'å…ˆæ—¥ã€è©±é¡Œã®SFæ˜ ç”»ã‚’è¦³ã¦ãã¾ã—ãŸã€‚æ˜ åƒç¾ãŒç´ æ™´ã‚‰ã—ã‹ã£ãŸã§ã™ã€‚', date: '2024-06-05', image: null, videoUrl: null, body: 'å…ˆæ—¥ã€è©±é¡Œã®SFå¤§ä½œæ˜ ç”»ã€Œã‚®ãƒ£ãƒ©ã‚¯ã‚·ãƒ¼ãƒ»ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼XXã€ã‚’è¦³ã¦ãã¾ã—ãŸã€‚<br>å£®å¤§ãªå®‡å®™ã®æ˜ åƒç¾ã¨ã€æ‰‹ã«æ±—æ¡ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒ³ã«åœ§å€’ã•ã‚Œã¾ã—ãŸã€‚<br>ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚‚æ„Ÿå‹•çš„ã§ã€è¦³çµ‚ã‚ã£ãŸå¾Œã—ã°ã‚‰ãä½™éŸ»ã«æµ¸ã£ã¦ã„ã¾ã—ãŸã€‚ãŠã™ã™ã‚ã§ã™ï¼' }, { id: 8, title: 'é€±æœ«ã®äºˆå®š', author: 'åº§ã®äººãƒ¦ãƒ¼ã‚¶ãƒ¼', snippet: 'ä»Šé€±æœ«ã¯ã€æ–°ã—ã„ã‚«ãƒ•ã‚§ã‚’é–‹æ‹“ã—ã«è¡Œãäºˆå®šã§ã™ã€‚æ¥½ã—ã¿ï¼', date: '2024-06-10', image: 'https://dummyimage.com/600x400/ffc107/000&text=Weekend', videoUrl: null, body: 'ä»Šé€±æœ«ã®äºˆå®šã¯â€¦<br>åœŸæ›œæ—¥ã¯ã€æœ€è¿‘ã‚ªãƒ¼ãƒ—ãƒ³ã—ãŸã¨å™‚ã®ãƒ–ãƒƒã‚¯ã‚«ãƒ•ã‚§ã«è¡Œã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚<br>ç¾å‘³ã—ã„ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’é£²ã¿ãªãŒã‚‰ã€ã‚†ã£ãã‚Šèª­æ›¸ãŒã§ããŸã‚‰æœ€é«˜ã§ã™ã­ã€‚<br>æ—¥æ›œæ—¥ã¯ã€å¤©æ°—ãŒè‰¯ã‘ã‚Œã°å…¬åœ’ã§ã®ã‚“ã³ã‚Šéã”ãã†ã‹ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚' }, { id: 9, title: 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å­¦ç¿’ã®é€²æ—', author: 'åº§ã®äººãƒ¦ãƒ¼ã‚¶ãƒ¼', snippet: 'JavaScriptã®éåŒæœŸå‡¦ç†ã«ã¤ã„ã¦å‹‰å¼·ä¸­ã€‚ãªã‹ãªã‹é›£ã—ã„ã‘ã©é¢ç™½ã„ã€‚', date: '2024-06-15', image: null, videoUrl: null, body: 'æœ€è¿‘ã¯JavaScriptã®éåŒæœŸå‡¦ç†ï¼ˆPromiseã‚„async/awaitï¼‰ã«ã¤ã„ã¦é›†ä¸­çš„ã«å‹‰å¼·ã—ã¦ã„ã¾ã™ã€‚<br>æ¦‚å¿µã‚’ç†è§£ã™ã‚‹ã®ãŒãªã‹ãªã‹å¤§å¤‰ã§ã™ãŒã€å°‘ã—ãšã¤åˆ†ã‹ã£ã¦ãã‚‹ã¨éå¸¸ã«é¢ç™½ã„ã§ã™ã€‚<br>å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦å‹•ã‹ã—ã¦ã¿ã‚‹ã®ãŒä¸€ç•ªã§ã™ã­ã€‚' }, { id: 10, title: 'ä»Šæ—¥ã®ãƒ©ãƒ³ãƒ', author: 'åº§ã®äººãƒ¦ãƒ¼ã‚¶ãƒ¼', snippet: 'ä»Šæ—¥ã¯æ‰‹ä½œã‚Šãƒ‘ã‚¹ã‚¿ã«æŒ‘æˆ¦ã€‚ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒãŒä¸Šæ‰‹ã«ã§ããŸï¼', date: '2024-06-17', image: 'https://dummyimage.com/600x400/28a745/fff&text=Pasta', videoUrl: null, body: 'ä»Šæ—¥ã®ãƒ©ãƒ³ãƒã¯ã€ä¹…ã—ã¶ã‚Šã«æ‰‹ä½œã‚Šãƒ‘ã‚¹ã‚¿ã«æŒ‘æˆ¦ã—ã¾ã—ãŸã€‚<br>å¿µé¡˜ã®ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒã§ã™ï¼<br>ãƒ‹ãƒ³ãƒ‹ã‚¯ã¨å”è¾›å­ã®é¢¨å‘³ã€ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«ã®ä¹³åŒ–ã‚‚ä¸Šæ‰‹ãã„ã£ã¦ã€éå»æœ€é«˜ã®å‡ºæ¥æ „ãˆã§ã—ãŸã€‚<br>ã‚„ã£ã±ã‚Šè‡ªåˆ†ã§ä½œã‚‹ã¨ç¾å‘³ã—ã„ã§ã™ã­ã€‚' } ]; },
    getSampleThreads: function() { return [ { id: 'thread001', title: 'ä»Šé€±æœ«ã®å¤©æ°—ã¨ãŠã™ã™ã‚ã‚¹ãƒãƒƒãƒˆ', category: 'zatsudan', accessCount: 2580, commentCount: 35, createdAt: new Date(Date.now() - 86400000 * 1).toISOString(), author: "ç®¡ç†äºº" }, { id: 'thread002', title: 'ã‚ã®æ–°ä½œæ˜ ç”»ã€è¦‹ãŸäººã„ã‚‹ï¼Ÿã€ãƒã‚¿ãƒãƒ¬æ³¨æ„ã€‘', category: 'tv', accessCount: 1890, commentCount: 152, createdAt: new Date(Date.now() - 86400000 * 2).toISOString(), author: "ãƒ¦ãƒ¼ã‚¶ãƒ¼A" }, { id: 'thread003', title: 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å­¦ç¿’ã§æœ€åˆã«ã¶ã¤ã‹ã‚‹å£', category: 'work', accessCount: 1550, commentCount: 88, createdAt: new Date(Date.now() - 86400000 * 3).toISOString(), author: "ãƒ¦ãƒ¼ã‚¶ãƒ¼B" }, { id: 'thread004', title: 'å¥åº·ã®ãŸã‚ã®é£Ÿç”Ÿæ´»æ”¹å–„ãƒ¬ãƒãƒ¼ãƒˆ', category: 'zatsudan', accessCount: 1230, commentCount: 45, createdAt: new Date(Date.now() - 86400000 * 0.5).toISOString(), author: "ãƒ¦ãƒ¼ã‚¶ãƒ¼C" }, { id: 'thread005', title: 'æœ€æ–°AIæŠ€è¡“ã®æ´»ç”¨äº‹ä¾‹ã¨å€«ç†å•é¡Œ', category: 'news', accessCount: 2200, commentCount: 62, createdAt: new Date(Date.now() - 86400000 * 4).toISOString(), author: "ç®¡ç†äºº" }, { id: 'thread006', title: 'ãŠæ°—ã«å…¥ã‚Šã®ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¼ã‚ºã‚²ãƒ¼ãƒ æ•™ãˆã¦ï¼', category: 'game', accessCount: 980, commentCount: 180, createdAt: new Date(Date.now() - 86400000 * 1.5).toISOString(), author: "ãƒ¦ãƒ¼ã‚¶ãƒ¼A" }, { id: 'thread007', title: 'ä»ŠæœŸã®è¦‡æ¨©ã‚¢ãƒ‹ãƒ¡ã¯ã“ã‚Œã ï¼å¾¹åº•è¨è«–', category: 'anime', accessCount: 1750, commentCount: 210, createdAt: new Date(Date.now() - 86400000 * 2.5).toISOString(), author: "ãƒ¦ãƒ¼ã‚¶ãƒ¼B" }, { id: 'thread008', title: 'å¿œæ´ã—ã¦ã‚‹ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ¼ãƒ ã®ç¾çŠ¶ã¨æœªæ¥', category: 'sports', accessCount: 1100, commentCount: 75, createdAt: new Date(Date.now() - 86400000 * 0.8).toISOString(), author: "ãƒ¦ãƒ¼ã‚¶ãƒ¼C" }, { id: 'thread009', title: 'è²·ã£ã¦ã‚ˆã‹ã£ãŸã‚¬ã‚¸ã‚§ãƒƒãƒˆ2024å¹´ä¸ŠåŠæœŸ', category: 'zatsudan', accessCount: 1950, commentCount: 92, createdAt: new Date(Date.now() - 86400000 * 5).toISOString(), author: "ç®¡ç†äºº" }, { id: 'thread010', title: 'æœ€è¿‘ã®ãƒ†ãƒ¬ãƒ“ç•ªçµ„ã€é¢ç™½ã„ã®æ¸›ã£ãŸï¼Ÿ', category: 'tv', accessCount: 850, commentCount: 130, createdAt: new Date(Date.now() - 86400000 * 6).toISOString(), author: "ãƒ¦ãƒ¼ã‚¶ãƒ¼A" }, ]; },
    getSampleEssayComments: function() { return { 1: [ { author: 'èª­è€…X', text: 'é–‹è¨­ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼æ¥½ã—ã¿ã«ã—ã¦ã„ã¾ã™ã€‚', date: '2024-05-21T12:00:00Z' }, { author: 'èª­è€…Y', text: 'é ‘å¼µã£ã¦ãã ã•ã„ï¼', date: '2024-05-21T15:30:00Z' } ], 3: [ { author: 'ãƒã‚¤ã‚«ãƒ¼Z', text: 'è¦‹æ™´ã‚‰ã—å±±ã€ã„ã„ã§ã™ã‚ˆã­ï¼ç§ã‚‚å¥½ãã§ã™ã€‚', date: '2024-05-20T09:00:00Z' } ], 6: [ { author: 'ã‚³ãƒ¡ãƒ³ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼Î±', text: 'åˆæŠ•ç¨¿ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼å¿œæ´ã—ã¦ã„ã¾ã™ã€‚', date: new Date(Date.now() - 86400000 * 0.5).toISOString() } ], 7: [ { author: 'æ˜ ç”»å¥½ãÎ²', text: 'ãã®æ˜ ç”»ã€ç§ã‚‚è¦‹ã¾ã—ãŸï¼æœ¬å½“ã«æœ€é«˜ã§ã—ãŸã­ï¼', date: new Date(Date.now() - 3600000 * 3).toISOString() } ] }; },
    getSamplePopularEssays: function() { return [ { id: 3, title: 'é€±æœ«ã®ãƒã‚¤ã‚­ãƒ³ã‚°è¨˜éŒ² (äººæ°—)', author: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼B', snippet: 'å¤©æ°—ãŒè‰¯ã‹ã£ãŸã®ã§ã€è¿‘ãã®å±±ã¸ãƒã‚¤ã‚­ãƒ³ã‚°ã«è¡Œã£ã¦ãã¾ã—ãŸã€‚é ‚ä¸Šã‹ã‚‰ã®æ™¯è‰²ã¯æœ€é«˜ã§ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã§ãã¾ã—ãŸï¼', date: '2024-05-19', views: 105, image: 'https://dummyimage.com/600x400/4CAF50/fff&text=Hiking+Detail' }, { id: 1, title: 'ã‚µã‚¤ãƒˆé–‹è¨­ã®ã”æŒ¨æ‹¶ (äººæ°—)', author: 'ç®¡ç†äºº', snippet: 'ã“ã®ã‚µã‚¤ãƒˆã€Œåº§ã®äººã€ã‚’é–‹è¨­ã—ã¾ã—ãŸã€‚æ—¥ã€…ã®é›‘è¨˜ã‚„æ€ã£ãŸã“ã¨ã‚’æ°—ã¾ã¾ã«ç¶´ã£ã¦ã„ãã¾ã™ã€‚', date: '2024-05-21', views: 98, image: 'https://dummyimage.com/600x400/777/fff&text=Greeting+Detail' }, { id: 10, title: 'ä»Šæ—¥ã®ãƒ©ãƒ³ãƒ (äººæ°—)', author: 'åº§ã®äººãƒ¦ãƒ¼ã‚¶ãƒ¼', snippet: 'ä»Šæ—¥ã¯æ‰‹ä½œã‚Šãƒ‘ã‚¹ã‚¿ã«æŒ‘æˆ¦ã€‚ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒãŒä¸Šæ‰‹ã«ã§ããŸï¼', date: '2024-06-17', views: 120, image: 'https://dummyimage.com/600x400/28a745/fff&text=Pasta' } ]; },
    getSampleNotifications: function() { return [ { id: 'noti001', type: 'comment', user: { name: 'ã‚³ãƒ¡ãƒ³ãƒˆã—ãŸäººA', profileUrl: 'profile.html?user=userA' }, essay: { title: 'ã‚µã‚¤ãƒˆé–‹è¨­ã®ã”æŒ¨æ‹¶', url: 'essay_detail.html?id=1' }, message: null, date: new Date(Date.now() - 3600000 * 2).toISOString(), read: false }, { id: 'noti002', type: 'follow', user: { name: 'åˆ®ç›®ã—ãŸäººB', profileUrl: 'profile.html?user=userB' }, essay: null, message: null, date: new Date(Date.now() - 3600000 * 5).toISOString(), read: true }, { id: 'noti003', type: 'system', user: null, essay: null, message: 'ã‚µã‚¤ãƒˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›ï¼šæ˜æ—¥åˆå‰2æ™‚ã‹ã‚‰3æ™‚ã¾ã§ã€ä¸€æ™‚çš„ã«ã‚µã‚¤ãƒˆã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ã€‚', date: new Date(Date.now() - 86400000 * 1).toISOString(), read: false }, { id: 'noti004', type: 'comment', user: { name: 'ã‚³ãƒ¡ãƒ³ãƒˆã—ãŸäººC', profileUrl: 'profile.html?user=userC' }, essay: { title: 'é€±æœ«ã®ãƒã‚¤ã‚­ãƒ³ã‚°è¨˜éŒ²', url: 'essay_detail.html?id=3' }, message: null, date: new Date(Date.now() - 86400000 * 2).toISOString(), read: true } ]; },
    initializeMediaItems: function() { this.mediaItems = []; this.essays.forEach(essay => { if (essay.image) { this.mediaItems.push({ type: 'essay_image', mediaUrl: essay.image, thumbnailUrl: essay.image, essayId: essay.id, essayTitle: essay.title, author: essay.author, timestamp: new Date(essay.date).getTime(), linkUrl: `essay_detail.html?id=${essay.id}` }); } if (essay.videoUrl) { this.mediaItems.push({ type: 'essay_video', mediaUrl: essay.videoUrl, thumbnailUrl: 'video_thumb_icon.png', essayId: essay.id, essayTitle: essay.title, author: essay.author, timestamp: new Date(essay.date).getTime(), linkUrl: `essay_detail.html?id=${essay.id}` }); } }); this.mediaItems.sort((a, b) => b.timestamp - a.timestamp); },
    
    // --- 2.4. ãƒšãƒ¼ã‚¸ã”ã¨ã®åˆæœŸåŒ–ãƒ¡ã‚½ãƒƒãƒ‰ç¾¤ ---
    async init() {
        this.initializeData();
        const path = window.location.pathname.split("/").pop() || 'index.html';
        console.log(`App: Initializing page: ${path}`);
        const pageInitializers = {
            'index.html': this.initIndexPage,
            'logged_in.html': this.initLoggedInPage,
            'essay_detail.html': this.initEssayDetailPage,
            'create_essay.html': this.initCreateEssayPage,
            'past_essays.html': this.initPastEssaysPage,
            'profile.html': this.initProfilePage,
            'notifications.html': this.initNotificationsPage,
            'bulletinboard.html': this.initBulletinboardPage,
            'thread_detail.html': this.initThreadDetailPage,
            'category_zatsudan.html': () => this.initCategoryPage('zatsudan'),
            'category_news.html': () => this.initCategoryPage('news'),
            'category_work.html': () => this.initCategoryPage('work'),
            'category_anime.html': () => this.initCategoryPage('anime'),
            'category_sports.html': () => this.initCategoryPage('sports'),
            'category_tv.html': () => this.initCategoryPage('tv'),
            'category_game.html': () => this.initCategoryPage('game'),
        };
        const initFunction = pageInitializers[path];
        if (typeof initFunction === 'function') { await initFunction.call(this); } else { console.warn("No specific initializer for this page:", path); }
        console.log(`App: Initialization finished for ${path}`);
    },

    initIndexPage: function() { console.log("Initializing Index Page..."); this.renderIndexEssayTimeline(); const loginForm = document.getElementById('login-form-aside'); if(loginForm) { loginForm.addEventListener('submit', (e) => { e.preventDefault(); alert('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ï¼ˆä»®ï¼‰'); window.location.href = 'logged_in.html'; }); } },
    async initLoggedInPage() { console.log("Initializing Logged-in Page..."); this.renderLeftColumn(); this.renderEssayTimeline(); this.renderPopularEssays(); this.renderRecentMedia(); this.renderLoggedInActiveThreads(); this.initializeTabs(); },
    async initEssayDetailPage() { console.log("Initializing Essay Detail Page..."); this.renderLeftColumn(); const essayId = getQueryParam('id'); if (essayId) { this.renderEssayDetail(parseInt(essayId, 10)); this.handleEssayCommentForm(parseInt(essayId, 10)); } else { const contentArea = document.getElementById('essay-detail-content'); if(contentArea) contentArea.innerHTML = '<p>ã‚¨ãƒ©ãƒ¼: éšç­†IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>'; } },
    async initCreateEssayPage() { console.log("Initializing Create Essay Page..."); this.renderLeftColumn(); this.handleCreateEssayForm(); },
    async initPastEssaysPage() { console.log("Initializing Past Essays Page..."); this.renderLeftColumn(); this.renderPastEssaysList(); },
    async initProfilePage() { console.log("Initializing Profile Page..."); this.renderLeftColumn(); this.renderRecentProfileEssays(); this.handleProfileForm(); },
    async initNotificationsPage() { console.log("Initializing Notifications Page..."); this.renderLeftColumn(); this.renderNotifications(); },
    async initBulletinboardPage() { console.log("Initializing Bulletin Board Page..."); this.renderLeftColumn('wakiaiai'); this.renderFeaturedThreads(); this.renderHotThreads(); },
    async initThreadDetailPage() { console.log("Initializing Thread Detail Page..."); const threadId = getQueryParam('id'); const currentThread = this.allThreads.find(t => t.id === threadId); let activeCategory = currentThread ? currentThread.category : null; this.renderLeftColumn(activeCategory); this.renderThreadDetail(); this.handleThreadCommentForm(); },
    async initCategoryPage(categoryKey) { console.log(`Initializing Category Page: ${categoryKey}`); this.renderLeftColumn(categoryKey); this.renderCategoryHeader(categoryKey); this.renderCategoryThreads(categoryKey); this.handleCreateThreadForm(categoryKey); },
    
    // --- 2.6. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ¡ã‚½ãƒƒãƒ‰ç¾¤ ---
    renderLeftColumn: function(activeCategory = null) { const userImageEl = document.getElementById('left-column-user-image'); const usernameTextEl = document.getElementById('left-column-username-text'); if (userImageEl) { userImageEl.src = this.currentUser.profileImageUrl || 'default_user_thumb.png'; userImageEl.alt = `${this.currentUser.name}ã®ç”»åƒ`; } if (usernameTextEl) { usernameTextEl.textContent = this.currentUser.name; } const followingList = document.getElementById('following-list-left-column'); if (followingList) { let html = ''; if (this.followingUsers && this.followingUsers.length > 0) { this.followingUsers.forEach(user => { html += `<li><a href="${user.profileUrl}">${escapeHtml(user.name)}</a></li>`; }); } else { html = '<li style="padding: 4px 15px; font-size: 0.9em; color: #777;">ã¾ã èª°ã‚‚ã„ã¾ã›ã‚“</li>'; } followingList.innerHTML = html; } },
    renderIndexEssayTimeline: function() { const timeline = document.getElementById('essay-timeline-index'); if (!timeline) return; timeline.innerHTML = '<li>ãƒ­ã‚°ã‚¤ãƒ³å‰ã®éšç­†ãƒªã‚¹ãƒˆã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>'; },
    renderEssayTimeline: function() { const timeline = document.getElementById('essay-timeline-logged-in'); if (!timeline) return; const sortedEssays = [...this.essays].sort((a, b) => new Date(b.date) - new Date(a.date)); let html = ''; if (sortedEssays.length > 0) { sortedEssays.forEach(essay => { html += `<li class="essay-item-logged-in"><div class="essay-title-container"><h4 class="essay-title-logged-in"><a href="essay_detail.html?id=${essay.id}">${escapeHtml(essay.title)}</a></h4><span class="essay-author-logged-in">by <a href="profile.html?user=${escapeHtml(essay.author)}">${escapeHtml(essay.author)}</a></span></div><p class="essay-snippet-logged-in">${escapeHtml(essay.snippet)}</p><div class="essay-meta-logged-in"><span>æŠ•ç¨¿æ—¥: ${essay.date}</span></div></li>`; }); } else { html = '<li>ã¾ã éšç­†ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li>'; } timeline.innerHTML = html; },
    renderPopularEssays: function() { const list = document.getElementById('popular-essays-list'); if (!list) return; let html = ''; if (this.popularEssays.length > 0) { this.popularEssays.forEach(essay => { html += `<li class="essay-item-logged-in"><div class="essay-title-container"><h4 class="essay-title-logged-in"><a href="essay_detail.html?id=${essay.id}">${escapeHtml(essay.title)}</a></h4><span class="essay-author-logged-in">by <a href="profile.html?user=${escapeHtml(essay.author)}">${escapeHtml(essay.author)}</a></span></div><p class="essay-snippet-logged-in">${escapeHtml(essay.snippet)}</p><div class="essay-meta-logged-in"><span>æŠ•ç¨¿æ—¥: ${essay.date}</span></div></li>`; }); } else { html = '<li>äººæ°—ã®éšç­†ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>'; } list.innerHTML = html; },
    renderRecentMedia: function() { const container = document.getElementById('recent-essay-images-tab'); if (!container) return; let html = ''; const recentMedia = this.mediaItems.slice(0, 8); if (recentMedia.length > 0) { recentMedia.forEach(item => { const mediaTag = item.type === 'essay_video' ? `<video src="${item.mediaUrl}" preload="metadata"></video>` : `<img src="${item.thumbnailUrl}" alt="${escapeHtml(item.essayTitle)}ã®ç”»åƒ">`; html += `<div class="recent-media-item"><a href="${item.linkUrl}" title="${escapeHtml(item.essayTitle)} by ${escapeHtml(item.author)}">${mediaTag}</a></div>`; }); } else { html = '<p>æœ€è¿‘æŠ•ç¨¿ã•ã‚ŒãŸç”»åƒã‚„å‹•ç”»ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>'; } container.innerHTML = html; },
    renderLoggedInActiveThreads: function() { const list = document.getElementById('active-threads-list'); if (!list) return; const activeThreads = [...this.allThreads].sort((a, b) => b.commentCount - a.commentCount).slice(0, 5); let html = ''; if(activeThreads.length > 0) { activeThreads.forEach((thread) => { html += `<li class="thread-list-item"><div class="thread-info-container"><a href="thread_detail.html?id=${thread.id}" class="thread-title-link"><span class="thread-category-badge">${escapeHtml(this.categoryDisplayNames[thread.category] || 'ãã®ä»–')}</span>${escapeHtml(thread.title)}</a><div class="thread-stats"><span>ã‚³ãƒ¡ãƒ³ãƒˆ: ${thread.commentCount}</span><span>ä½œæˆæ—¥: ${new Date(thread.createdAt).toLocaleDateString()}</span></div></div></li>`; }); } else { html = '<li>ç¾åœ¨ã«ãã‚„ã‹ãªã‚¹ãƒ¬ãƒƒãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>'; } list.innerHTML = html; },
    renderRecentProfileEssays: function() { const list = document.getElementById('recent-profile-essays-list'); if (!list) return; const userEssays = this.essays.filter(essay => essay.author === this.currentUser.name); const sortedEssays = userEssays.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5); let html = ''; if (sortedEssays.length > 0) { sortedEssays.forEach(essay => { html += `<li class="essay-item-logged-in"><div class="essay-title-container"><h4 class="essay-title-logged-in"><a href="essay_detail.html?id=${essay.id}">${escapeHtml(essay.title)}</a></h4><span class="essay-author-logged-in">by <a href="profile.html?user=${escapeHtml(essay.author)}">${escapeHtml(essay.author)}</a></span></div><p class="essay-snippet-logged-in">${escapeHtml(essay.snippet)}</p><div class="essay-meta-logged-in"><span>æŠ•ç¨¿æ—¥: ${essay.date}</span></div></li>`; }); } else { html = `<li>${escapeHtml(this.currentUser.name)}ã•ã‚“ã®éšç­†ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</li>`; } list.innerHTML = html; },
    renderNotifications: function() { const list = document.getElementById('notification-list-area'); if (!list) return; const sortedNotifications = [...this.notifications].sort((a, b) => new Date(b.date) - new Date(a.date)); let html = ''; if (sortedNotifications.length > 0) { sortedNotifications.forEach(noti => { let iconHtml = ''; let textHtml = ''; const unreadClass = noti.read ? '' : 'notification-unread'; switch (noti.type) { case 'comment': iconHtml = 'ğŸ’¬'; textHtml = `<a href="${noti.user.profileUrl}">${escapeHtml(noti.user.name)}</a>ã•ã‚“ãŒã‚ãªãŸã®éšç­†ã€Œ<a href="${noti.essay.url}">${escapeHtml(noti.essay.title)}</a>ã€ã«ä¸€è¨€ç”³ã—ã¾ã—ãŸã€‚`; break; case 'follow': iconHtml = 'ğŸ‘€'; textHtml = `<a href="${noti.user.profileUrl}">${escapeHtml(noti.user.name)}</a>ã•ã‚“ãŒã‚ãªãŸã‚’åˆ®ç›®ã—å§‹ã‚ã¾ã—ãŸã€‚`; break; case 'system': iconHtml = 'âš™ï¸'; textHtml = escapeHtml(noti.message); break; default: iconHtml = 'ğŸ””'; textHtml = 'æ–°ã—ã„é€šçŸ¥ãŒã‚ã‚Šã¾ã™ã€‚'; } html += `<li class="notification-item ${unreadClass}"><div class="notification-icon">${iconHtml}</div><div class="notification-content"><p class="notification-text">${textHtml}</p><span class="notification-date">${new Date(noti.date).toLocaleString('ja-JP')}</span></div></li>`; }); } else { html = '<li style="text-align: center; padding: 20px;">æ–°ã—ã„é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>'; } list.innerHTML = html; },
    renderPastEssaysList: function() { const listArea = document.getElementById('past-essays-list-area'); if (!listArea) return; const userEssays = this.essays.filter(essay => essay.author === this.currentUser.name); const sortedEssays = userEssays.sort((a, b) => new Date(b.date) - new Date(a.date)); let html = ''; if (sortedEssays.length > 0) { sortedEssays.forEach(essay => { html += `<li class="past-essay-list-item"><a href="essay_detail.html?id=${essay.id}"><span class="past-essay-list-title">${escapeHtml(essay.title)}</span><span class="past-essay-list-meta">æŠ•ç¨¿æ—¥: ${essay.date}</span><p class="past-essay-list-snippet">${escapeHtml(essay.snippet)}</p></a></li>`; }); } else { html = `<li style="text-align: center; padding: 20px;">${escapeHtml(this.currentUser.name)}ã•ã‚“ã®éšç­†ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</li>`; } listArea.innerHTML = html; },
    
    // â˜…â˜…â˜… renderEssayDetail ã‚’ä¿®æ­£ â˜…â˜…â˜…
    renderEssayDetail: function(essayId) {
        const contentArea = document.getElementById('essay-detail-content');
        if (!contentArea) return;

        const essay = this.essays.find(e => e.id === essayId);
        if (!essay) { contentArea.innerHTML = '<p>æŒ‡å®šã•ã‚ŒãŸéšç­†ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>'; return; }

        let mediaHtml = '';
        if (essay.image) { mediaHtml = `<img src="${essay.image}" alt="éšç­†ã®ç”»åƒ">`; } 
        else if (essay.videoUrl) { mediaHtml = `<video src="${essay.videoUrl}" controls width="100%">ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»ã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚</video>`; }

        let commentsHtml = '';
        const comments = this.allComments[essayId] || [];
        if (comments.length > 0) {
            comments.forEach(comment => {
                commentsHtml += `<div class="comment-item"><p class="comment-author">${escapeHtml(comment.author)}</p><p class="comment-text">${escapeHtml(comment.text)}</p><p class="comment-date">${new Date(comment.date).toLocaleString('ja-JP')}</p></div>`;
            });
        } 
        // â˜…â˜…â˜… ã€Œã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤ â˜…â˜…â˜…
        
        const detailHtml = `
            <div class="essay-title-area"><h2>${escapeHtml(essay.title)}</h2></div>
            <div class="essay-meta-detail-wrapper"><div class="essay-meta-detail"><span>æŠ•ç¨¿è€…: <a href="profile.html?user=${escapeHtml(essay.author)}">${escapeHtml(essay.author)}</a></span><time datetime="${new Date(essay.date).toISOString()}">æŠ•ç¨¿æ—¥æ™‚: ${essay.date}</time></div></div>
            <article><section class="essay-media">${mediaHtml}</section><section class="essay-body">${essay.body}</section></article>
            <section class="comments-section">
                <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
                <div id="comments-list">${commentsHtml}</div>
                <form id="comment-form" style="margin-top: 20px;">
                    <div>
                        <label for="comment-text-input">ã‚³ãƒ¡ãƒ³ãƒˆ:</label>
                        <textarea id="comment-text-input" name="comment-text" rows="3" 
                                  placeholder="ã‚ãªãŸã®å£°ã¯100æ–‡å­—ã¾ã§ã§ã™" 
                                  required maxlength="100"></textarea>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: flex-end; gap: 10px;">
                        <span id="comment-char-counter" class="char-counter" style="font-size: 0.9em;">0/100</span>
                        <button type="submit">æŠ•ç¨¿ã™ã‚‹</button>
                    </div>
                </form>
            </section>
        `;
        contentArea.innerHTML = detailHtml;
    },

    renderFeaturedThreads: function() { console.log("renderFeaturedThreads is not implemented yet."); },
    renderHotThreads: function() { console.log("renderHotThreads is not implemented yet."); },
    renderThreadDetail: function() { console.log("renderThreadDetail is not implemented yet."); },
    renderCategoryHeader: function(categoryKey) { console.log(`renderCategoryHeader for ${categoryKey} is not implemented yet.`); },
    renderCategoryThreads: function(categoryKey) { console.log(`renderCategoryThreads for ${categoryKey} is not implemented yet.`); },
    
    // --- 2.7. ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ»ãã®ä»– ---
    initializeTabs: function() { const tabContainer = document.querySelector('.tab-container-logged-in, .tab-container'); if (!tabContainer) return; const tabButtons = tabContainer.querySelectorAll('.tab-button-logged-in, .tab-button'); const tabContents = tabContainer.querySelectorAll('.tab-content-logged-in, .tab-content'); tabButtons.forEach(button => { button.addEventListener('click', () => { tabButtons.forEach(btn => btn.classList.remove('active')); tabContents.forEach(content => content.classList.remove('active')); button.classList.add('active'); const activeContent = tabContainer.querySelector(`#${button.dataset.tab}`); if (activeContent) activeContent.classList.add('active'); }); }); },
    handleEssayCommentForm: function(essayId) { const form = document.getElementById('comment-form'); if (!form) { setTimeout(() => this.handleEssayCommentForm(essayId), 100); return; } const commentTextInput = document.getElementById('comment-text-input'); const counter = document.getElementById('comment-char-counter'); const MAX_COMMENT_LENGTH = 100; const updateCommentCounter = () => { if (!commentTextInput || !counter) return; const currentLength = commentTextInput.value.length; counter.textContent = `${currentLength}/${MAX_COMMENT_LENGTH}`; counter.classList.toggle('error', currentLength > MAX_COMMENT_LENGTH); }; commentTextInput.addEventListener('input', updateCommentCounter); updateCommentCounter(); form.addEventListener('submit', (e) => { e.preventDefault(); const commentText = commentTextInput.value.trim(); if (commentText.length > MAX_COMMENT_LENGTH) { alert(`ã‚³ãƒ¡ãƒ³ãƒˆã®æ–‡å­—æ•°ãŒä¸Šé™ï¼ˆ${MAX_COMMENT_LENGTH}æ–‡å­—ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`); return; } if (commentText) { const newComment = { author: this.currentUser.name, text: commentText, date: new Date().toISOString() }; if (!this.allComments[essayId]) { this.allComments[essayId] = []; } this.allComments[essayId].push(newComment); localStorage.setItem('allComments', JSON.stringify(this.allComments)); this.renderEssayDetail(essayId); this.handleEssayCommentForm(essayId); } }); },
    handleCreateEssayForm: function() { const form = document.getElementById('essay-form'); if (!form) return; const titleInput = document.getElementById('essay-title'); const contentInput = document.getElementById('essay-content'); const titleCounter = document.getElementById('title-char-counter'); const contentCounter = document.getElementById('content-char-counter'); const mediaInput = document.getElementById('essay-media'); const previewText = document.getElementById('preview-text'); const imagePreview = document.getElementById('image-preview'); const videoPreview = document.getElementById('video-preview'); const MAX_TITLE_LENGTH = 30; const MAX_CONTENT_LENGTH = 1000; const updateCounter = (input, counter, maxLength) => { if (!input || !counter) return; const currentLength = input.value.length; counter.textContent = `${currentLength}/${maxLength}`; counter.classList.toggle('error', currentLength > maxLength); }; titleInput.addEventListener('input', () => updateCounter(titleInput, titleCounter, MAX_TITLE_LENGTH)); contentInput.addEventListener('input', () => updateCounter(contentInput, contentCounter, MAX_CONTENT_LENGTH)); updateCounter(titleInput, titleCounter, MAX_TITLE_LENGTH); updateCounter(contentInput, contentCounter, MAX_CONTENT_LENGTH); mediaInput.addEventListener('change', (e) => { const file = e.target.files[0]; previewText.style.display = 'block'; imagePreview.style.display = 'none'; videoPreview.style.display = 'none'; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { previewText.style.display = 'none'; if (file.type.startsWith('image/')) { imagePreview.src = event.target.result; imagePreview.style.display = 'block'; } else if (file.type.startsWith('video/')) { videoPreview.src = event.target.result; videoPreview.style.display = 'block'; } }; reader.readAsDataURL(file); }); form.addEventListener('submit', (e) => { e.preventDefault(); const title = titleInput.value; const content = contentInput.value; if (title.length > MAX_TITLE_LENGTH) { alert(`ã‚¿ã‚¤ãƒˆãƒ«ã®æ–‡å­—æ•°ãŒä¸Šé™ï¼ˆ${MAX_TITLE_LENGTH}æ–‡å­—ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`); return; } if (content.length > MAX_CONTENT_LENGTH) { alert(`æœ¬æ–‡ã®æ–‡å­—æ•°ãŒä¸Šé™ï¼ˆ${MAX_CONTENT_LENGTH}æ–‡å­—ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`); return; } const mediaFile = mediaInput.files[0]; const today = new Date(); const dateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`; const snippet = content.replace(/\n/g, ' ').substring(0, 100) + (content.length > 100 ? '...' : ''); const newEssay = { id: Date.now(), title: title, author: this.currentUser.name, snippet: snippet, date: dateString, body: content.replace(/\n/g, '<br>'), image: null, videoUrl: null }; const saveAndRedirect = (mediaDataUrl = null) => { if (mediaDataUrl && mediaFile) { if (mediaFile.type.startsWith('image/')) { newEssay.image = mediaDataUrl; } else if (mediaFile.type.startsWith('video/')) { newEssay.videoUrl = mediaDataUrl; } } this.saveNewEssay(newEssay); alert('éšç­†ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼'); window.location.href = 'logged_in.html'; }; if (mediaFile) { const reader = new FileReader(); reader.onloadend = () => { saveAndRedirect(reader.result); }; reader.readAsDataURL(mediaFile); } else { saveAndRedirect(); } }); },
    handleProfileForm: function() { const profileDisplay = document.getElementById('profile-display'); const profileEditForm = document.getElementById('profile-edit-form'); if (!profileDisplay || !profileEditForm) return; const editButton = document.getElementById('edit-profile-button'); const cancelButton = document.getElementById('cancel-edit-button'); const form = document.getElementById('profile-edit-form'); const imagePreview = document.getElementById('image-preview'); const imageInput = document.getElementById('edit_profile_image'); const displayImage = document.getElementById('display-profile-image'); let currentProfileData = JSON.parse(localStorage.getItem('userProfile') || '{}'); const updateDisplay = () => { for (const key in this.profileFields) { const displayEl = document.getElementById(this.profileFields[key].display); if (displayEl) { let value = currentProfileData[key] || '[æœªè¨­å®š]'; if (key === 'gender') value = this.genderMap[currentProfileData[key]] || '[æœªè¨­å®š]'; if (key === 'blood_type') value = this.bloodTypeMap[currentProfileData[key]] || '[æœªè¨­å®š]'; displayEl.textContent = value; } } displayImage.src = currentProfileData.profileImage || 'default_user_thumb.png'; this.renderLeftColumn(); }; const populateForm = () => { for (const key in this.profileFields) { const editEl = document.getElementById(this.profileFields[key].edit); if (editEl) { editEl.value = currentProfileData[key] || ''; } } imagePreview.src = currentProfileData.profileImage || 'default_user_thumb.png'; imageInput.value = ''; }; updateDisplay(); editButton.addEventListener('click', () => { currentProfileData = JSON.parse(localStorage.getItem('userProfile') || '{}'); populateForm(); profileDisplay.style.display = 'none'; profileEditForm.style.display = 'block'; }); cancelButton.addEventListener('click', () => { profileEditForm.style.display = 'none'; profileDisplay.style.display = 'block'; }); imageInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { imagePreview.src = event.target.result; }; reader.readAsDataURL(file); } }); form.addEventListener('submit', (e) => { e.preventDefault(); const newProfileData = {}; for (const key in this.profileFields) { newProfileData[key] = document.getElementById(this.profileFields[key].edit).value; } const saveProfile = (imageData) => { if (imageData) { newProfileData.profileImage = imageData; } else { newProfileData.profileImage = currentProfileData.profileImage; } localStorage.setItem('userProfile', JSON.stringify(newProfileData)); this.currentUser.name = newProfileData.username || 'åº§ã®äººãƒ¦ãƒ¼ã‚¶ãƒ¼'; this.currentUser.profileImageUrl = newProfileData.profileImage || 'default_user_thumb.png'; currentProfileData = newProfileData; updateDisplay(); profileEditForm.style.display = 'none'; profileDisplay.style.display = 'block'; alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼'); }; const file = imageInput.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => saveProfile(reader.result); reader.readAsDataURL(file); } else { saveProfile(null); } }); },
    handleThreadCommentForm: function() { console.log("handleThreadCommentForm is not implemented yet."); },
    handleCreateThreadForm: function(categoryKey) { console.log(`handleCreateThreadForm for ${categoryKey} is not implemented yet.`); },
    saveNewEssay: function(essayData) { const essays = JSON.parse(localStorage.getItem('essays') || '[]'); essays.unshift(essayData); localStorage.setItem('essays', JSON.stringify(essays)); console.log("New essay saved:", essayData); },
};

// --- 3. DOMContentLoaded ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ ---
document.addEventListener('DOMContentLoaded', async () => {
    const path = window.location.pathname.split("/").pop() || 'index.html';
    const leftColumnPages = ['logged_in.html', 'essay_detail.html', 'create_essay.html', 'past_essays.html', 'profile.html', 'notifications.html'];
    if (leftColumnPages.includes(path)) {
        const container = document.getElementById('left-column-container');
        if (typeof loadHTMLPart === 'function' && container) {
            await loadHTMLPart('_left_column_logged_in.html', 'left-column-container');
        } else {
            if(!container) console.log("Left column container not found on this page.");
            else console.error("loadHTMLPart is not defined, left column will not be loaded.");
        }
    }
    App.init();
});